@model List<SocialMedia.Models.PostModel>

<style>
    body {
        font-family: Arial;
    }

    .topbar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .post {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background: #f9f9f9;
    }

    .like-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }

    input {
        padding: 5px;
    }

    button {
        padding: 5px 10px;
        cursor: pointer;
    }
</style>

<div class="topbar">
    <h2>All Posts</h2>

    <div>
        <a asp-controller="UserDashboard" asp-action="Index">👤 My Profile</a> |
        <a asp-controller="Auth" asp-action="Logout">Logout</a>
    </div>
</div>

<!-- CREATE POST -->
<form method="post" asp-controller="Post" asp-action="Create">
    <input name="content" placeholder="Write post..." required />
    <button type="submit">Post</button>
</form>

<hr />

@if (Model.Any())
{
    foreach (var post in Model)
    {
        <div class="post">

            <p>@post.Content</p>

            <button type="button"
                    onclick="likePost(@post.Id)"
                    style="background:#ff4d6d;color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;">

                ❤️ <span id="like-count-@post.Id">
                    @(post.Likes != null ? post.Likes.Count : 0)
                </span>

            </button>

            <hr />

            <h4>Comments</h4>

            <div id="comments-@post.Id">
                @foreach (var c in post.Comments)
                {
                    <p>- @c.Content</p>
                }
            </div>

            <input id="comment-input-@post.Id"
                   placeholder="Add comment..." />

            <button onclick="addComment(@post.Id)">
                Send
            </button>

        </div>
    }
}
else
{
    <p>No posts yet.</p>
}

<script>

    function likePost(postId) {
        fetch('/Post/Like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'postId=' + postId
        })
        .then(r => {
            if (!r.ok) throw new Error("Like failed");
            return r.json();
        })
        .then(d => {
            document.getElementById('like-count-' + postId)
                .innerText = d.count;
        })
        .catch(e => alert(e));
    }

    function addComment(postId) {

        const input = document.getElementById('comment-input-' + postId);
        const content = input.value.trim();

        if (!content) return;

        fetch('/Post/AddComment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'postId=' + postId + '&content=' + encodeURIComponent(content)
        })
        .then(r => {
            if (!r.ok) throw new Error("Comment failed");
            return r.json();
        })
        .then(data => {

            document.getElementById('comments-' + postId)
                .innerHTML += `<p>- ${data.content}</p>`;

            input.value = "";
        })
        .catch(e => alert(e));
    }

</script>
